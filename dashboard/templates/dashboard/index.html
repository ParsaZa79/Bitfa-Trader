{% load humanize %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bitfa Trader — Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: '#0f1117',
            card: '#161a25',
            border: '#1e2433',
            accent: '#00c896',
            loss: '#f6465d',
            win: '#0ecb81',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f1117; }
    ::-webkit-scrollbar-thumb { background: #2a3040; border-radius: 3px; }
    .glow-green { box-shadow: 0 0 20px rgba(0, 200, 150, 0.08); }
    .glow-red { box-shadow: 0 0 20px rgba(246, 70, 93, 0.08); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.4s ease-out both; }
    .fade-in-1 { animation-delay: 0.05s; }
    .fade-in-2 { animation-delay: 0.1s; }
    .fade-in-3 { animation-delay: 0.15s; }
    .fade-in-4 { animation-delay: 0.2s; }
    .fade-in-5 { animation-delay: 0.25s; }
    table { border-collapse: separate; border-spacing: 0; }
  </style>
</head>
<body class="bg-surface text-gray-200 min-h-screen">

  <!-- Header -->
  <header class="border-b border-border bg-card/60 backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-[1440px] mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-accent to-emerald-600 flex items-center justify-center text-white font-bold text-sm">BT</div>
        <h1 class="text-xl font-semibold text-white tracking-tight">Bitfa Trader</h1>
        <span class="text-xs text-gray-500 bg-gray-800/60 px-2 py-0.5 rounded-full ml-1">Dashboard</span>
      </div>
      <div class="flex items-center gap-2 text-xs text-gray-500">
        <div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div>
        Live
      </div>
    </div>
  </header>

  <main class="max-w-[1440px] mx-auto px-6 py-6 space-y-6">

    <!-- Overview Cards -->
    <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-1">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Total Signals</p>
        <p class="text-2xl font-bold text-white">{{ total_signals }}</p>
      </div>
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-2">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Open Positions</p>
        <p class="text-2xl font-bold text-yellow-400">{{ open_positions }}</p>
      </div>
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-3">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Closed Positions</p>
        <p class="text-2xl font-bold text-gray-300">{{ closed_positions }}</p>
      </div>
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-4 {% if total_pnl >= 0 %}glow-green{% else %}glow-red{% endif %}">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Total PnL</p>
        <p class="text-2xl font-bold {% if total_pnl >= 0 %}text-win{% else %}text-loss{% endif %}">
          {% if total_pnl >= 0 %}+{% endif %}{{ total_pnl|floatformat:2 }} USDT
        </p>
      </div>
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Unrealized PnL</p>
        <p class="text-2xl font-bold {% if unrealized_pnl >= 0 %}text-win{% else %}text-loss{% endif %}">
          {% if unrealized_pnl >= 0 %}+{% endif %}{{ unrealized_pnl|floatformat:2 }}
        </p>
      </div>
      <div class="bg-card border border-border rounded-xl p-4 fade-in fade-in-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Win Rate</p>
        <p class="text-2xl font-bold text-white">{{ win_rate }}%</p>
        <p class="text-[10px] text-gray-600 mt-0.5">{{ winning }}/{{ closed_positions }} wins</p>
      </div>
    </section>

    <!-- PnL Chart -->
    <section class="bg-card border border-border rounded-xl p-5 fade-in">
      <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Cumulative PnL</h2>
      <div class="h-64">
        <canvas id="pnlChart"></canvas>
      </div>
    </section>

    <!-- Two-column: Signals + Activity -->
    <div class="grid lg:grid-cols-3 gap-6">

      <!-- Signals Table -->
      <section class="lg:col-span-2 bg-card border border-border rounded-xl overflow-hidden fade-in">
        <div class="px-5 py-4 border-b border-border flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Signals</h2>
          <span class="text-xs text-gray-600">Last 50</span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-xs text-gray-500 uppercase tracking-wider border-b border-border">
                <th class="px-4 py-3 text-left">Symbol</th>
                <th class="px-4 py-3 text-left">Dir</th>
                <th class="px-4 py-3 text-right">Entry</th>
                <th class="px-4 py-3 text-right">SL</th>
                <th class="px-4 py-3 text-right">TP1</th>
                <th class="px-4 py-3 text-center">Lev</th>
                <th class="px-4 py-3 text-center">Status</th>
                <th class="px-4 py-3 text-right">Time</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              {% for s in signals %}
              <tr class="hover:bg-white/[0.02] transition-colors">
                <td class="px-4 py-3 font-medium text-white">{{ s.symbol }}</td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold {% if s.direction == 'long' %}bg-win/10 text-win{% else %}bg-loss/10 text-loss{% endif %}">
                    {{ s.direction|upper }}
                  </span>
                </td>
                <td class="px-4 py-3 text-right font-mono text-gray-300">{{ s.entry_price_low }}</td>
                <td class="px-4 py-3 text-right font-mono text-loss/70">{{ s.stop_loss }}</td>
                <td class="px-4 py-3 text-right font-mono text-win/70">{{ s.tp1|default:"-" }}</td>
                <td class="px-4 py-3 text-center text-gray-400">{{ s.leverage }}×</td>
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium uppercase tracking-wider
                    {% if s.status == 'active' %}bg-yellow-500/10 text-yellow-400
                    {% elif s.status == 'closed' %}bg-gray-500/10 text-gray-400
                    {% elif s.status == 'new' %}bg-accent/10 text-accent
                    {% elif s.status == 'cancelled' %}bg-loss/10 text-loss
                    {% else %}bg-gray-500/10 text-gray-500{% endif %}">
                    {{ s.get_status_display }}
                  </span>
                </td>
                <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ s.created_at|date:"M d H:i" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="8" class="px-4 py-12 text-center text-gray-600">No signals yet</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Activity Feed -->
      <section class="bg-card border border-border rounded-xl overflow-hidden fade-in">
        <div class="px-5 py-4 border-b border-border">
          <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Activity</h2>
        </div>
        <div class="divide-y divide-border max-h-[480px] overflow-y-auto">
          {% for a in activities %}
          <div class="px-4 py-3 hover:bg-white/[0.02] transition-colors">
            <div class="flex items-start gap-2.5">
              <span class="text-lg mt-0.5 shrink-0">{{ a.icon }}</span>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-white text-sm">{{ a.symbol }}</span>
                  <span class="text-xs {{ a.color }}">{{ a.type }}</span>
                </div>
                {% if a.detail %}
                <p class="text-xs text-gray-500 mt-0.5 truncate">{{ a.detail }}</p>
                {% endif %}
                <p class="text-[10px] text-gray-600 mt-1">{{ a.time|date:"M d H:i:s" }}</p>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="px-4 py-12 text-center text-gray-600">No activity yet</div>
          {% endfor %}
        </div>
      </section>
    </div>

    <!-- Positions Table -->
    <section class="bg-card border border-border rounded-xl overflow-hidden fade-in">
      <div class="px-5 py-4 border-b border-border flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Positions</h2>
        <span class="text-xs text-gray-600">Last 50</span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-gray-500 uppercase tracking-wider border-b border-border">
              <th class="px-4 py-3 text-left">Symbol</th>
              <th class="px-4 py-3 text-left">Side</th>
              <th class="px-4 py-3 text-right">Entry Price</th>
              <th class="px-4 py-3 text-right">Qty</th>
              <th class="px-4 py-3 text-center">Leverage</th>
              <th class="px-4 py-3 text-right">Realized PnL</th>
              <th class="px-4 py-3 text-right">Unrealized PnL</th>
              <th class="px-4 py-3 text-center">Status</th>
              <th class="px-4 py-3 text-right">Opened</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {% for p in positions %}
            <tr class="hover:bg-white/[0.02] transition-colors">
              <td class="px-4 py-3 font-medium text-white">{{ p.symbol }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold {% if p.side == 'long' %}bg-win/10 text-win{% else %}bg-loss/10 text-loss{% endif %}">
                  {{ p.side|upper }}
                </span>
              </td>
              <td class="px-4 py-3 text-right font-mono text-gray-300">{{ p.entry_price|default:"-" }}</td>
              <td class="px-4 py-3 text-right font-mono text-gray-400">{{ p.quantity }}</td>
              <td class="px-4 py-3 text-center text-gray-400">{{ p.leverage }}×</td>
              <td class="px-4 py-3 text-right font-mono {% if p.realized_pnl > 0 %}text-win{% elif p.realized_pnl < 0 %}text-loss{% else %}text-gray-500{% endif %}">
                {% if p.realized_pnl > 0 %}+{% endif %}{{ p.realized_pnl|floatformat:2 }}
              </td>
              <td class="px-4 py-3 text-right font-mono {% if p.unrealized_pnl > 0 %}text-win{% elif p.unrealized_pnl < 0 %}text-loss{% else %}text-gray-500{% endif %}">
                {% if p.unrealized_pnl > 0 %}+{% endif %}{{ p.unrealized_pnl|floatformat:2 }}
              </td>
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium uppercase tracking-wider
                  {% if p.status == 'open' %}bg-accent/10 text-accent
                  {% elif p.status == 'closed' %}bg-gray-500/10 text-gray-400
                  {% elif p.status == 'pending' %}bg-yellow-500/10 text-yellow-400
                  {% elif p.status == 'failed' %}bg-loss/10 text-loss
                  {% else %}bg-gray-500/10 text-gray-500{% endif %}">
                  {{ p.get_status_display }}
                </span>
              </td>
              <td class="px-4 py-3 text-right text-gray-500 text-xs">{{ p.opened_at|date:"M d H:i"|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="9" class="px-4 py-12 text-center text-gray-600">No positions yet</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Exchange: Live Data from LBank -->
    <section class="bg-card border border-border rounded-xl overflow-hidden fade-in" id="exchange-section">
      <div class="px-5 py-4 border-b border-border flex items-center justify-between">
        <div class="flex items-center gap-2">
          <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Exchange — LBank Live</h2>
          <span id="exchange-status" class="text-[10px] text-gray-600"></span>
        </div>
        <button onclick="loadExchangeData()" class="text-xs text-accent hover:text-accent/80 transition-colors">⟳ Refresh</button>
      </div>

      <!-- Account Summary -->
      <div id="account-summary" class="px-5 py-3 border-b border-border hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"></div>
      </div>

      <!-- Exchange Positions -->
      <div class="px-5 py-3 border-b border-border">
        <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-2">Open Positions (Exchange)</h3>
        <div id="exchange-positions" class="overflow-x-auto">
          <p class="text-gray-600 text-sm py-4 text-center">Loading...</p>
        </div>
      </div>

      <!-- Exchange Open Orders -->
      <div class="px-5 py-3">
        <h3 class="text-xs text-gray-500 uppercase tracking-wider mb-2">Open Orders (Exchange)</h3>
        <div id="exchange-orders" class="overflow-x-auto">
          <p class="text-gray-600 text-sm py-4 text-center">Loading...</p>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="border-t border-border mt-8 py-4 text-center text-xs text-gray-600">
    Bitfa Trader Dashboard — Internal Use
  </footer>

  <script>
    // PnL Chart
    fetch('/api/pnl-chart/')
      .then(r => r.json())
      .then(d => {
        const ctx = document.getElementById('pnlChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 256);
        const isPositive = d.data.length === 0 || d.data[d.data.length - 1] >= 0;
        gradient.addColorStop(0, isPositive ? 'rgba(14, 203, 129, 0.15)' : 'rgba(246, 70, 93, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: d.labels,
            datasets: [{
              label: 'Cumulative PnL (USDT)',
              data: d.data,
              borderColor: isPositive ? '#0ecb81' : '#f6465d',
              backgroundColor: gradient,
              borderWidth: 2,
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 5,
              pointHoverBackgroundColor: isPositive ? '#0ecb81' : '#f6465d',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e2433',
                titleColor: '#9ca3af',
                bodyColor: '#fff',
                borderColor: '#2a3040',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: item => `${item.parsed.y >= 0 ? '+' : ''}${item.parsed.y.toFixed(2)} USDT`
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)' },
                ticks: { color: '#4b5563', maxTicksLimit: 10, font: { size: 10 } },
                border: { color: '#1e2433' }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.03)' },
                ticks: {
                  color: '#4b5563',
                  font: { size: 10 },
                  callback: v => `${v >= 0 ? '+' : ''}${v.toFixed(0)}`
                },
                border: { color: '#1e2433' }
              }
            }
          }
        });
      });
  </script>

  <script>
    function loadExchangeData() {
      document.getElementById('exchange-status').textContent = 'Fetching...';
      fetch('/api/exchange/')
        .then(r => r.json())
        .then(d => {
          document.getElementById('exchange-status').textContent = d.error ? '⚠ ' + d.error : '✓ Updated';

          // Account
          const acc = d.account;
          if (acc && Object.keys(acc).length) {
            const el = document.getElementById('account-summary');
            el.classList.remove('hidden');
            el.querySelector('div').innerHTML = `
              <div><span class="text-gray-500 text-xs">Balance</span><p class="font-mono text-white">${acc.availableBalance || acc.balance || '-'} USDT</p></div>
              <div><span class="text-gray-500 text-xs">Equity</span><p class="font-mono text-white">${acc.equity || acc.accountEquity || '-'}</p></div>
              <div><span class="text-gray-500 text-xs">Margin Used</span><p class="font-mono text-yellow-400">${acc.usedMargin || acc.frozenBalance || '-'}</p></div>
              <div><span class="text-gray-500 text-xs">Unrealized PnL</span><p class="font-mono ${parseFloat(acc.unrealizedPnl || acc.unPnl || 0) >= 0 ? 'text-win' : 'text-loss'}">${acc.unrealizedPnl || acc.unPnl || '0'}</p></div>
            `;
          }

          // Positions
          const posEl = document.getElementById('exchange-positions');
          const positions = d.positions;
          if (positions && positions.length > 0) {
            let html = `<table class="w-full text-sm"><thead><tr class="text-xs text-gray-500 uppercase border-b border-border">
              <th class="px-3 py-2 text-left">Symbol</th><th class="px-3 py-2 text-left">Side</th>
              <th class="px-3 py-2 text-right">Size</th><th class="px-3 py-2 text-right">Entry</th>
              <th class="px-3 py-2 text-right">Mark Price</th><th class="px-3 py-2 text-center">Leverage</th>
              <th class="px-3 py-2 text-right">PnL</th></tr></thead><tbody class="divide-y divide-border">`;
            positions.forEach(p => {
              const pnl = parseFloat(p.unPnl || p.unrealizedPnl || 0);
              const side = (p.side || p.positionSide || '').toLowerCase();
              html += `<tr class="hover:bg-white/[0.02]">
                <td class="px-3 py-2 font-medium text-white">${p.symbol || p.contractId || '-'}</td>
                <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-semibold ${side.includes('long') || side.includes('buy') ? 'bg-win/10 text-win' : 'bg-loss/10 text-loss'}">${side.toUpperCase()}</span></td>
                <td class="px-3 py-2 text-right font-mono text-gray-300">${p.positionSize || p.volume || p.amount || '-'}</td>
                <td class="px-3 py-2 text-right font-mono text-gray-300">${p.avgPrice || p.entryPrice || '-'}</td>
                <td class="px-3 py-2 text-right font-mono text-gray-400">${p.markPrice || p.lastPrice || '-'}</td>
                <td class="px-3 py-2 text-center text-gray-400">${p.leverage || '-'}×</td>
                <td class="px-3 py-2 text-right font-mono ${pnl >= 0 ? 'text-win' : 'text-loss'}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}</td>
              </tr>`;
            });
            html += '</tbody></table>';
            posEl.innerHTML = html;
          } else {
            posEl.innerHTML = '<p class="text-gray-600 text-sm py-4 text-center">No open positions on exchange</p>';
          }

          // Orders
          const ordEl = document.getElementById('exchange-orders');
          const orders = d.open_orders;
          if (orders && orders.length > 0) {
            let html = `<table class="w-full text-sm"><thead><tr class="text-xs text-gray-500 uppercase border-b border-border">
              <th class="px-3 py-2 text-left">Symbol</th><th class="px-3 py-2 text-left">Side</th>
              <th class="px-3 py-2 text-left">Type</th><th class="px-3 py-2 text-right">Price</th>
              <th class="px-3 py-2 text-right">Qty</th><th class="px-3 py-2 text-right">Filled</th>
              <th class="px-3 py-2 text-center">Status</th></tr></thead><tbody class="divide-y divide-border">`;
            orders.forEach(o => {
              const side = (o.side || o.direction || '').toLowerCase();
              html += `<tr class="hover:bg-white/[0.02]">
                <td class="px-3 py-2 font-medium text-white">${o.symbol || o.contractId || '-'}</td>
                <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-semibold ${side.includes('buy') || side.includes('long') ? 'bg-win/10 text-win' : 'bg-loss/10 text-loss'}">${side.toUpperCase()}</span></td>
                <td class="px-3 py-2 text-gray-400 text-xs">${o.type || o.orderType || '-'}</td>
                <td class="px-3 py-2 text-right font-mono text-gray-300">${o.price || '-'}</td>
                <td class="px-3 py-2 text-right font-mono text-gray-300">${o.origQty || o.volume || o.amount || '-'}</td>
                <td class="px-3 py-2 text-right font-mono text-gray-400">${o.executedQty || o.filledVolume || '0'}</td>
                <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-yellow-500/10 text-yellow-400">${o.status || 'OPEN'}</span></td>
              </tr>`;
            });
            html += '</tbody></table>';
            ordEl.innerHTML = html;
          } else {
            ordEl.innerHTML = '<p class="text-gray-600 text-sm py-4 text-center">No open orders on exchange</p>';
          }
        })
        .catch(err => {
          document.getElementById('exchange-status').textContent = '⚠ Error: ' + err.message;
        });
    }
    // Auto-load on page load
    loadExchangeData();
    // Auto-refresh every 30s
    setInterval(loadExchangeData, 30000);
  </script>
</body>
</html>
